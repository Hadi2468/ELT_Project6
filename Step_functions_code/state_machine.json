{
  "Comment": "Project 6 ETL Orchestration",
  "StartAt": "TriggerCodePipeline",
  "States": {
    "TriggerCodePipeline": {
      "Type": "Task",
      "Resource": "arn:aws:states:::codepipeline:startPipelineExecution",
      "Parameters": { "Name": "project6-github-codepipeline" },
      "Next": "RunGlueMarketingBronze"
    },
    "RunGlueMarketingBronze": {
      "Type": "Task",
      "Resource": "arn:aws:states:::glue:startJobRun.sync",
      "Parameters": {
        "JobName": "project6-marketing-bronze",
        "Arguments": {
          "--input_bucket": "s3://project6-bronze-bucket/",
          "--output_bucket": "s3://project6-silver-bucket/"
        }
      },
      "Next": "project6-bronze-silver-emr"
    },
    "project6-bronze-silver-emr": {
      "Type": "Parallel",
      "Branches": [
        {
          "StartAt": "SilverEventsJob",
          "States": {
            "SilverEventsJob": {
              "Type": "Task",
              "Resource": "arn:aws:states:::emr-serverless:startJobRun.sync",
              "Parameters": {
                "ApplicationId": "00g2mkec38ghf109",
                "ExecutionRoleArn": "arn:aws:iam::000185048470:role/project6-emr-role",
                "JobDriver": {
                  "SparkSubmit": {
                    "EntryPoint": "s3://project6-code-bucket/Spark_codes/project6-silver-events.py",
                    "EntryPointArguments": ["project6-bronze-bucket", "events/", "project6-silver-bucket"],
                    "SparkSubmitParameters": "--jars s3://project6-jars/delta-core_2.12-2.1.0.jar,s3://project6-jars/hadoop-aws-3.3.4.jar,s3://project6-jars/aws-java-sdk-bundle-1.12.538.jar --conf spark.sql.extensions=io.delta.sql.DeltaSparkSessionExtension --conf spark.sql.catalog.spark_catalog=org.apache.spark.sql.delta.catalog.DeltaCatalog --conf spark.sql.sources.partitionOverwriteMode=dynamic --conf spark.delta.logStore.class=org.apache.spark.sql.delta.storage.S3SingleDriverLogStore"
                  }
                }
              },
              "End": true
            }
          }
        },
        {
          "StartAt": "SilverMarketingJob",
          "States": {
            "SilverMarketingJob": {
              "Type": "Task",
              "Resource": "arn:aws:states:::emr-serverless:startJobRun.sync",
              "Parameters": {
                "ApplicationId": "00g2mkec38ghf109",
                "ExecutionRoleArn": "arn:aws:iam::000185048470:role/project6-emr-role",
                "JobDriver": {
                  "SparkSubmit": {
                    "EntryPoint": "s3://project6-code-bucket/Spark_codes/project6-silver-marketing.py",
                    "EntryPointArguments": ["project6-bronze-bucket", "marketing/", "project6-silver-bucket"],
                    "SparkSubmitParameters": "--jars s3://project6-jars/delta-core_2.12-2.1.0.jar,s3://project6-jars/hadoop-aws-3.3.4.jar,s3://project6-jars/aws-java-sdk-bundle-1.12.538.jar --conf spark.sql.extensions=io.delta.sql.DeltaSparkSessionExtension --conf spark.sql.catalog.spark_catalog=org.apache.spark.sql.delta.catalog.DeltaCatalog --conf spark.sql.sources.partitionOverwriteMode=dynamic --conf spark.delta.logStore.class=org.apache.spark.sql.delta.storage.S3SingleDriverLogStore"
                  }
                }
              },
              "End": true
            }
          }
        }
      ],
      "Next": "project6-silver-gold-emr"
    },
    "project6-silver-gold-emr": {
      "Type": "Task",
      "Resource": "arn:aws:states:::emr-serverless:startJobRun.sync",
      "Parameters": {
        "ApplicationId": "00g2o8eatb8fni09",
        "ExecutionRoleArn": "arn:aws:iam::000185048470:role/project6-emr-role",
        "JobDriver": {
          "SparkSubmit": {
            "EntryPoint": "s3://project6-code-bucket/Spark_codes/project6-gold.py",
            "EntryPointArguments": ["project6-silver-bucket", "project6-gold-bucket"],
            "SparkSubmitParameters": "--jars s3://project6-jars/delta-core_2.12-2.1.0.jar,s3://project6-jars/hadoop-aws-3.3.4.jar,s3://project6-jars/aws-java-sdk-bundle-1.12.538.jar --conf spark.sql.extensions=io.delta.sql.DeltaSparkSessionExtension --conf spark.sql.catalog.spark_catalog=org.apache.spark.sql.delta.catalog.DeltaCatalog --conf spark.sql.sources.partitionOverwriteMode=dynamic --conf spark.delta.logStore.class=org.apache.spark.sql.delta.storage.S3SingleDriverLogStore"
          }
        }
      },
      "End": true
    }
  }
}
